# Mobile-MCP ç³»ç»Ÿäº¤äº’æ¶æ„

## éƒ¨ç½²æ‹“æ‰‘

```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚                        ç”¨æˆ·ç”µè„‘                                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Electron App                            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Main Process   â”‚        â”‚    Renderer Process      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  IPC   â”‚                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ MCP Manager   â”‚â—„â•â•â•â•â•â•â–ºâ”‚  â€¢ React UI (Vite)      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ oRPC Handler  â”‚        â”‚  â€¢ Chat SDK             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ çª—å£ç®¡ç†       â”‚        â”‚  â€¢ Zustand Stores       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚          â”‚                              â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚ spawn/kill                   â”‚ HTTP                â”‚
â”‚             â–¼                              â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                     â”‚
â”‚  â”‚    MCP Server        â”‚                  â”‚                     â”‚
â”‚  â”‚    (HTTP :3100)      â”‚                  â”‚                     â”‚
â”‚  â”‚                      â”‚                  â”‚                     â”‚
â”‚  â”‚  â€¢ SSE ç«¯ç‚¹: /sse    â”‚                  â”‚                     â”‚
â”‚  â”‚  â€¢ POST: /messages   â”‚                  â”‚                     â”‚
â”‚  â”‚  â€¢ BasicToolsLite    â”‚                  â”‚                     â”‚
â”‚  â”‚  â€¢ MobileClient      â”‚                  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                     â”‚
â”‚          â”‚ u2 / WDA                        â”‚                     â”‚
â”‚          â–¼                                 â”‚                     â”‚
â”‚       ğŸ“± æ‰‹æœº (USB/WiFi)                    â”‚                     â”‚
â”‚                                            â”‚                     â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
                                             â”‚
                        â”€â”€â”€â”€â”€â”€â”€ ç½‘ç»œ â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€
                                             â”‚
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚                      æœåŠ¡ç«¯ç”µè„‘              â”‚                     â”‚
â”‚                                            â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  FastAPI Backend (:8088)                  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ API è·¯ç”±  â”‚  â”‚  Agent     â”‚  â”‚  MCPConnection       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚          â”‚  â”‚ (LangGraph)â”‚  â”‚  (SSE Client)        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ /chat    â”‚â”€â–ºâ”‚            â”‚â”€â–ºâ”‚                      â”‚â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â–º MCP Server
â”‚  â”‚  â”‚ /status  â”‚  â”‚ checkpointer  â”‚  url: MCP_SERVER_URL â”‚  â”‚   â”‚    (SSE)
â”‚  â”‚  â”‚ /conv    â”‚  â”‚ middleware â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”‚ /settingsâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â”‚  â”‚ /devices â”‚                                            â”‚   â”‚
â”‚  â”‚  â”‚ /screenshot                                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ checkpoint.db    â”‚  â”‚ mobile_agent.db              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (Agent å†…éƒ¨çŠ¶æ€)  â”‚  â”‚ (ä¼šè¯/æ¶ˆæ¯/æˆªå›¾)             â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
```

> **è¯´æ˜**ï¼šæœ¬åœ°å¼€å‘æ—¶ï¼ŒæœåŠ¡ç«¯ç”µè„‘ = ç”¨æˆ·ç”µè„‘ï¼ŒBackend ä¹Ÿåœ¨æœ¬åœ°è¿è¡Œã€‚

---

## åº”ç”¨å¯åŠ¨æ—¶åºå›¾

```
æ—¶é—´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

â”Œâ”€ Electron Main Process â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  â‘  startMcpServer()                                                      â”‚
â”‚  â”‚  spawn("python mcp_server.py --sse --port 3100")                      â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  â”Œâ”€ MCP Server å­è¿›ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”‚  â‘¡ å¯åŠ¨ Starlette HTTP æœåŠ¡                                     â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ æ³¨å†Œ GET  /sse      (SSE äº‹ä»¶æµç«¯ç‚¹)                     â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ æ³¨å†Œ POST /messages (å·¥å…·è°ƒç”¨ç«¯ç‚¹)                       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”‚  â‘¢ uvicorn.run(host=0.0.0.0, port=3100)                         â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ ğŸŸ¢ MCP Server å°±ç»ªï¼Œç­‰å¾… SSE è¿æ¥                       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”‚  â‘£ é¦–æ¬¡å·¥å…·è°ƒç”¨æ—¶ â†’ å»¶è¿Ÿåˆå§‹åŒ–è®¾å¤‡è¿æ¥                            â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â”€ æ£€æµ‹å¹³å° (Android/iOS)                                   â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€â”€ MobileClient(platform) â†’ u2/WDA è¿æ¥æ‰‹æœº                  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€ BasicMobileToolsLite(client) â†’ 27 ä¸ªå·¥å…·å°±ç»ª              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â‘¤ createWindow()                                                        â”‚
â”‚  â”‚  â”œâ”€â”€ new BrowserWindow(1440Ã—900)                                      â”‚
â”‚  â”‚  â””â”€â”€ loadURL(Vite dev server / æ‰“åŒ…å HTML)                           â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â”‚  â”Œâ”€ Renderer Process â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”‚  â‘¥ React App æŒ‚è½½                                              â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ TanStack Router åˆå§‹åŒ–è·¯ç”±                              â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ Zustand Stores åˆå§‹åŒ–                                   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ Chat SDK (ChatClient) å‡†å¤‡å°±ç»ª                          â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”‚  â‘¦ Dashboard é¡µé¢è‡ªåŠ¨è¯·æ±‚åç«¯çŠ¶æ€                                â”‚   â”‚
â”‚  â”‚  â”‚     â”œâ”€â”€ GET /api/v1/status   â†’ æ£€æŸ¥ Backend + MCP è¿æ¥çŠ¶æ€      â”‚   â”‚
â”‚  â”‚  â”‚     â””â”€â”€ GET /api/v1/devices  â†’ è·å–è®¾å¤‡åˆ—è¡¨                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â‘§ installExtensions() â†’ React DevTools (å¼€å‘æ¨¡å¼)                       â”‚
â”‚  â‘¨ checkForUpdates()   â†’ Electron è‡ªåŠ¨æ›´æ–°æ£€æŸ¥                           â”‚
â”‚  â‘© setupORPC()         â†’ æ³¨å†Œ IPC é€šé“ (theme/window/app/shell)         â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€ FastAPI Backend (ç‹¬ç«‹è¿›ç¨‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  â¶ åŠ è½½é…ç½®                                                              â”‚
â”‚  â”‚  â”œâ”€â”€ .env æ–‡ä»¶ / ç¯å¢ƒå˜é‡                                             â”‚
â”‚  â”‚  â”œâ”€â”€ LLMConfig  (model, api_key, base_url)                            â”‚
â”‚  â”‚  â”œâ”€â”€ MCPConfig  (url: http://localhost:3100/sse)                      â”‚
â”‚  â”‚  â””â”€â”€ AgentConfig (host, port, max_iterations)                         â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â· åˆå§‹åŒ– Storage (åº”ç”¨ä¸šåŠ¡æ•°æ®)                                          â”‚
â”‚  â”‚  â”œâ”€â”€ aiosqlite.connect("data/mobile_agent.db")                        â”‚
â”‚  â”‚  â”œâ”€â”€ PRAGMA journal_mode=WAL                                          â”‚
â”‚  â”‚  â”œâ”€â”€ PRAGMA foreign_keys=ON                                           â”‚
â”‚  â”‚  â””â”€â”€ CREATE TABLE conversations / messages / screenshots              â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â¸ åˆå§‹åŒ– Checkpointer (Agent å†…éƒ¨çŠ¶æ€)                                   â”‚
â”‚  â”‚  â”œâ”€â”€ aiosqlite.connect("data/checkpoint.db")                          â”‚
â”‚  â”‚  â”œâ”€â”€ PRAGMA journal_mode=WAL                                          â”‚
â”‚  â”‚  â””â”€â”€ AsyncSqliteSaver.setup() â†’ å»º checkpoints è¡¨                     â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â¹ è¿æ¥ MCP Server (SSE)                                                 â”‚
â”‚  â”‚  â”œâ”€â”€ MultiServerMCPClient({"mobile-mcp": {url, transport: "sse"}})    â”‚
â”‚  â”‚  â”œâ”€â”€ HTTP GET â†’ MCP Server /sse â†’ å»ºç«‹ SSE é•¿è¿æ¥                     â”‚
â”‚  â”‚  â””â”€â”€ get_tools() â†’ è·å– 27 ä¸ª LangChain BaseTool                     â”‚
â”‚  â”‚                                                                       â”‚
â”‚  âº æ„å»º Agent (LangGraph)                                                â”‚
â”‚  â”‚  â”œâ”€â”€ _create_model_instance(llm_config) â†’ LLM å®ä¾‹                    â”‚
â”‚  â”‚  â”œâ”€â”€ create_agent(model, tools, checkpointer, middleware)             â”‚
â”‚  â”‚  â”‚   â””â”€â”€ middleware: [OperationLogger, ScreenshotOptimizer, Retry]    â”‚
â”‚  â”‚  â””â”€â”€ ğŸŸ¢ Agent å°±ç»ª                                                   â”‚
â”‚  â”‚                                                                       â”‚
â”‚  â» å¯åŠ¨ FastAPI                                                          â”‚
â”‚     â”œâ”€â”€ æ³¨å†Œè·¯ç”±: /chat, /status, /screenshot, /devices,                 â”‚
â”‚     â”‚            /conversations, /settings                               â”‚
â”‚     â”œâ”€â”€ CORS ä¸­é—´ä»¶ (allow_origins=*)                                    â”‚
â”‚     â””â”€â”€ uvicorn.run(host=0.0.0.0, port=8088)                            â”‚
â”‚         â””â”€â”€ ğŸŸ¢ Backend å°±ç»ªï¼Œç­‰å¾…è¯·æ±‚                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯åŠ¨å®Œæˆåçš„å°±ç»ªçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å°±ç»ªçŠ¶æ€æ£€æŸ¥                            â”‚
â”‚                                                         â”‚
â”‚  âœ… MCP Server      :3100  â”‚ SSE ç«¯ç‚¹å°±ç»ª               â”‚
â”‚  âœ… æ‰‹æœºè¿æ¥         u2/WDA â”‚ é¦–æ¬¡å·¥å…·è°ƒç”¨æ—¶è‡ªåŠ¨è¿æ¥      â”‚
â”‚  âœ… Backend          :8088  â”‚ Agent + LLM å°±ç»ª           â”‚
â”‚  âœ… Storage          SQLite â”‚ ä¸¤ä¸ª .db æ–‡ä»¶å·²åˆå§‹åŒ–       â”‚
â”‚  âœ… Electron         UI     â”‚ çª—å£å·²åˆ›å»ºï¼ŒReact å·²æŒ‚è½½    â”‚
â”‚                                                         â”‚
â”‚  ç”¨æˆ·å¯ä»¥å¼€å§‹è¾“å…¥æŒ‡ä»¤ â”€â”€â†’ "æ‰“å¼€å¾®ä¿¡"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´äº¤äº’æµç¨‹

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```
Electron Main Process
  â”‚
  â”œâ”€â‘  spawn MCP Server (python mcp_server.py --sse --port 3100)
  â”‚   â””â”€â”€ MCP Server å¯åŠ¨ HTTP æœåŠ¡ï¼Œç›‘å¬ :3100
  â”‚       â”œâ”€â”€ GET  /sse      â†’ SSE äº‹ä»¶æµç«¯ç‚¹
  â”‚       â””â”€â”€ POST /messages â†’ å·¥å…·è°ƒç”¨æ¥æ”¶ç«¯ç‚¹
  â”‚
  â”œâ”€â‘¡ createWindow() â†’ åˆ›å»º BrowserWindow
  â”‚   â””â”€â”€ åŠ è½½ Renderer (React App)
  â”‚
  â””â”€â‘¢ setupORPC() â†’ æ³¨å†Œ IPC é€šé“
```

```
FastAPI Backend (ç‹¬ç«‹å¯åŠ¨)
  â”‚
  â”œâ”€â‘  åˆå§‹åŒ– Storage (data/mobile_agent.db)
  â”‚   â””â”€â”€ å»ºè¡¨: conversations, messages, screenshots
  â”‚
  â”œâ”€â‘¡ åˆå§‹åŒ– Checkpointer (data/checkpoint.db)
  â”‚   â””â”€â”€ AsyncSqliteSaver + WAL æ¨¡å¼
  â”‚
  â”œâ”€â‘¢ è¿æ¥ MCP Server (SSE)
  â”‚   â””â”€â”€ MultiServerMCPClient â†’ GET /sse
  â”‚   â””â”€â”€ è·å– LangChain BaseTool åˆ—è¡¨ (27 ä¸ªå·¥å…·)
  â”‚
  â””â”€â‘£ æ„å»º Agent (LangGraph)
      â””â”€â”€ create_agent(model, tools, checkpointer, middleware)
```

### 2. èŠå¤©äº¤äº’æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰

```
ç”¨æˆ·è¾“å…¥ "æ‰“å¼€å¾®ä¿¡"
  â”‚
  â–¼
Renderer (React)
  â”‚ POST /api/v1/chat {message, conversation_id}
  â–¼
FastAPI Backend
  â”‚
  â”œâ”€â‘  åˆ›å»º MobileOrchestrator
  â”‚   â””â”€â”€ æ³¨å…¥ service, emitter, conversation_id
  â”‚
  â”œâ”€â‘¡ è¿”å› SSE Response (create_sse_response)
  â”‚
  â”œâ”€â‘¢ Agent å¼€å§‹æ¨ç† (astream)
  â”‚   â”‚
  â”‚   â”œâ”€ AIMessage (æ€è€ƒ)
  â”‚   â”‚   â””â”€â”€ emitter â†’ SSE event: message.delta
  â”‚   â”‚
  â”‚   â”œâ”€ ToolCall (è°ƒç”¨ mobile_launch_app)
  â”‚   â”‚   â””â”€â”€ emitter â†’ SSE event: tool.start
  â”‚   â”‚   â”‚
  â”‚   â”‚   â–¼
  â”‚   â”‚   MCPConnection (SSE Client)
  â”‚   â”‚   â”‚ POST /messages â†’ MCP Server
  â”‚   â”‚   â–¼
  â”‚   â”‚   MCP Server
  â”‚   â”‚   â”‚ handle_tool_call("mobile_launch_app", {package_name: "com.tencent.mm"})
  â”‚   â”‚   â”‚ â””â”€â”€ BasicMobileToolsLite.launch_app()
  â”‚   â”‚   â”‚     â””â”€â”€ MobileClient.u2.app_start("com.tencent.mm")
  â”‚   â”‚   â”‚         â””â”€â”€ ğŸ“± æ‰‹æœºå¯åŠ¨å¾®ä¿¡
  â”‚   â”‚   â”‚
  â”‚   â”‚   â—„â”€â”€ è¿”å›å·¥å…·ç»“æœ (TextContent)
  â”‚   â”‚
  â”‚   â”œâ”€ ToolMessage (ç»“æœ)
  â”‚   â”‚   â””â”€â”€ MobileResponseHandler._handle_tool_message()
  â”‚   â”‚       â”œâ”€â”€ æ™®é€šç»“æœ â†’ emitter: tool.end {output_preview}
  â”‚   â”‚       â””â”€â”€ æˆªå›¾ç»“æœ â†’ Storage.save_screenshot()
  â”‚   â”‚                    â†’ emitter: tool.end {screenshot_id}
  â”‚   â”‚
  â”‚   â””â”€ AIMessage (æœ€ç»ˆå›å¤ "å·²æ‰“å¼€å¾®ä¿¡")
  â”‚       â””â”€â”€ emitter â†’ SSE event: message.delta
  â”‚
  â””â”€â‘£ emitter â†’ SSE event: __end__
```

```
Renderer (React) æ¥æ”¶ SSE äº‹ä»¶æµ
  â”‚
  â”œâ”€â”€ message.delta â†’ æ˜¾ç¤º AI æ–‡æœ¬ï¼ˆæµå¼æ‰“å­—æ•ˆæœï¼‰
  â”œâ”€â”€ tool.start    â†’ æ˜¾ç¤º "æ­£åœ¨æ‰§è¡Œ: mobile_launch_app"
  â”œâ”€â”€ tool.end      â†’ æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
  â”‚   â””â”€â”€ å« screenshot_id â†’ è¯·æ±‚ GET /api/v1/screenshot/{id}
  â”‚                          â†’ æ˜¾ç¤ºæˆªå›¾å›¾ç‰‡
  â””â”€â”€ __end__       â†’ å®Œæˆï¼Œæ¢å¤è¾“å…¥æ¡†
```

### 3. æˆªå›¾è·å–æµç¨‹

```
Renderer
  â”‚ GET /api/v1/screenshot/{screenshot_id}
  â–¼
FastAPI Backend
  â”‚ await service.get_screenshot(id)
  â”‚ â””â”€â”€ Storage._db.execute("SELECT data FROM screenshots WHERE id=?")
  â”‚
  â—„â”€â”€ Response(content=image_bytes, media_type="image/png")
```

### 4. ä¼šè¯ç®¡ç†æµç¨‹

```
ä¼šè¯åˆ—è¡¨:
  Renderer â†’ GET /api/v1/conversations?query=xxx
           â†’ Backend â†’ Storage.list_conversations()
           â†’ è¿”å› [{id, title, status, steps, duration, created_at}]

ä¼šè¯è¯¦æƒ…:
  Renderer â†’ GET /api/v1/conversations/{id}
           â†’ Backend â†’ Storage.get_conversation(id)
           â†’ è¿”å› {id, title, messages: [{role, content, tool_name, has_image}]}

åˆ é™¤ä¼šè¯:
  Renderer â†’ DELETE /api/v1/conversations/{id}
           â†’ Backend â†’ Storage.delete_conversation(id)  (çº§è”åˆ é™¤æ¶ˆæ¯)
```

### 5. è®¾ç½®ç®¡ç†æµç¨‹

```
è·å–è®¾ç½®:
  Renderer â†’ GET /api/v1/settings
           â†’ Backend â†’ service.get_settings_snapshot()
           â†’ è¿”å› {llm: {model, api_key, base_url}, mcp: {url}, agent, middleware}

æ›´æ–°è®¾ç½®:
  Renderer â†’ PUT /api/v1/settings {llm?: {...}, mcp?: {url}, ...}
           â†’ Backend â†’ service.update_settings(updates)
           â†’ è¿”å›æ›´æ–°åçš„å®Œæ•´è®¾ç½®

æµ‹è¯• LLM:
  Renderer â†’ POST /api/v1/settings/test-llm
           â†’ Backend â†’ _create_model_instance() â†’ LLM API
           â†’ è¿”å› {success, message, model, latency_ms}

é‡è¿ MCP:
  Renderer â†’ POST /api/v1/settings/reconnect-mcp
           â†’ Backend â†’ MCPConnection.reconnect() (SSE é‡è¿)
           â†’ é‡å»º Agent
           â†’ è¿”å› {success, message, tools_count}
```

### 6. è®¾å¤‡ç®¡ç†æµç¨‹

```
è®¾å¤‡åˆ—è¡¨:
  Renderer â†’ GET /api/v1/devices
           â†’ Backend â†’ å ä½å“åº” (è®¾å¤‡ä¿¡æ¯éœ€é€šè¿‡ MCP å·¥å…·è·å–)
           â†’ è¿”å› {devices: []}

çŠ¶æ€æŸ¥è¯¢:
  Renderer â†’ GET /api/v1/status
           â†’ Backend â†’ service.get_status()
           â†’ è¿”å› {ready, mcp_connected, mcp_url, tools_count, tools, uptime_seconds}
```

### 7. åº”ç”¨é€€å‡ºæµç¨‹

```
ç”¨æˆ·å…³é—­çª—å£
  â”‚
  â–¼
Electron Main Process
  â”‚
  â”œâ”€â‘  app.on("will-quit")
  â”‚   â””â”€â”€ stopMcpServer()
  â”‚       â””â”€â”€ SIGTERM â†’ MCP Server è¿›ç¨‹
  â”‚       â””â”€â”€ 3s è¶…æ—¶ â†’ SIGKILL (å¼ºåˆ¶)
  â”‚
  â””â”€â‘¡ MCP Server è¿›ç¨‹é€€å‡º
```

```
FastAPI Backend (ç‹¬ç«‹å…³é—­)
  â”‚
  â”œâ”€â‘  æ–­å¼€ MCP SSE è¿æ¥
  â”œâ”€â‘¡ å…³é—­ Storage (mobile_agent.db)
  â””â”€â‘¢ å…³é—­ Checkpointer (checkpoint.db)
```

---

## æ•°æ®æŒä¹…åŒ–

```
data/
â”œâ”€â”€ checkpoint.db      â† ç¬¬ 1 å±‚: LangGraph Agent å†…éƒ¨çŠ¶æ€
â”‚                        å¤šè½®å¯¹è¯è®°å¿†ï¼ˆmessage historyï¼‰
â”‚                        Agent æ¢å¤ä¸Šä¸‹æ–‡ç”¨
â”‚
â””â”€â”€ mobile_agent.db    â† ç¬¬ 2 å±‚: åº”ç”¨ä¸šåŠ¡æ•°æ®
    â”œâ”€â”€ conversations    ä¼šè¯åˆ—è¡¨ï¼ˆid, title, status, steps, durationï¼‰
    â”œâ”€â”€ messages         æ¶ˆæ¯è®°å½•ï¼ˆrole, content, tool_name, has_imageï¼‰
    â””â”€â”€ screenshots      æˆªå›¾ç¼“å­˜ï¼ˆbase64 data, æœ€å¤šä¿ç•™ 50 å¼ ï¼‰
```

---

## ä¸­é—´ä»¶å¤„ç†é“¾

```
Agent æ¯ä¸€æ­¥æ‰§è¡Œæ—¶ï¼Œä¸­é—´ä»¶æŒ‰é¡ºåºå¤„ç†:

  OperationLoggerMiddleware
  â”‚ â””â”€â”€ emitter: step.start / step.end äº‹ä»¶
  â–¼
  ScreenshotOptimizerMiddleware
  â”‚ â””â”€â”€ é™åˆ¶è¿ç»­æˆªå›¾æ¬¡æ•° (max_consecutive: 2)
  â–¼
  RetryMiddleware
  â”‚ â””â”€â”€ å·¥å…·å¤±è´¥è‡ªåŠ¨é‡è¯• (max_attempts: 2, interval: 1s)
  â”‚     â””â”€â”€ emitter: tool.retry äº‹ä»¶
  â–¼
  å®é™…å·¥å…·æ‰§è¡Œ (MCP Server)
```

---

## ç«¯å£/URL æ±‡æ€»

| æœåŠ¡ | é»˜è®¤åœ°å€ | ç¯å¢ƒå˜é‡ |
|------|---------|---------|
| **MCP Server (SSE)** | `http://localhost:3100/sse` | `MCP_SERVER_URL` |
| **FastAPI Backend** | `http://localhost:8088` | `AGENT_HOST` / `AGENT_PORT` |
| **Electron Renderer** | `http://localhost:5173` (dev) | Vite dev server |
