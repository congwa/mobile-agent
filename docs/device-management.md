# è®¾å¤‡è¿æ¥ç®¡ç†æ‹“æ‰‘

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MCP Server è¿›ç¨‹                                  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     MobileMCPServer                                â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  client: MobileClient | None     â† å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¦–æ¬¡å·¥å…·è°ƒç”¨æ—¶åˆ›å»º   â”‚  â”‚
â”‚  â”‚  tools:  BasicMobileToolsLite | None                               â”‚  â”‚
â”‚  â”‚  _initialized: bool              â† æ˜¯å¦å·²æˆåŠŸåˆå§‹åŒ–                â”‚  â”‚
â”‚  â”‚  _last_error: str | None         â† æœ€åä¸€æ¬¡è¿æ¥å¤±è´¥çš„é”™è¯¯          â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              initialize() å»¶è¿Ÿåˆå§‹åŒ–æµç¨‹                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  å·²åˆå§‹åŒ–? â”€â”€Yesâ”€â”€â–º _is_connection_valid()?                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                  â”‚            â”‚                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      No             æœ‰æ•ˆ(return)  æ— æ•ˆ(é‡ç½®çŠ¶æ€,é‡è¿)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â–¼                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  _detect_platform()                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â”€ ç¯å¢ƒå˜é‡ MOBILE_PLATFORM=android â†’ "android"        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â”€ ç¯å¢ƒå˜é‡ MOBILE_PLATFORM=ios    â†’ "ios"             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â”€ IOSDeviceManagerWDA.list_devices() æœ‰ç»“æœ â†’ "ios"   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â””â”€â”€ é»˜è®¤ â†’ "android"                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â–¼                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  MobileClient(platform=xxx)                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  BasicMobileToolsLite(client)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”œâ”€â”€ æˆåŠŸ â†’ _initialized=True, æ‰“å° "ğŸ“± å·²è¿æ¥"         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â””â”€â”€ å¤±è´¥ â†’ _initialized=False, _last_error=xxx         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 "ä¸‹æ¬¡è°ƒç”¨æ—¶å°†é‡è¯•"                            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Android è®¾å¤‡è¿æ¥é“¾è·¯

```
MobileMCPServer.initialize()
  â”‚
  â–¼
MobileClient(platform="android")
  â”‚
  â”œâ”€â”€ DeviceManager(platform="android")
  â”‚   â”‚
  â”‚   â”œâ”€â”€ _find_adb()  â† æŸ¥æ‰¾ ADB å¯æ‰§è¡Œæ–‡ä»¶
  â”‚   â”‚   â”œâ”€â”€ $ANDROID_HOME/platform-tools/adb
  â”‚   â”‚   â”œâ”€â”€ /usr/local/bin/adb
  â”‚   â”‚   â”œâ”€â”€ ~/Library/Android/sdk/platform-tools/adb
  â”‚   â”‚   â””â”€â”€ PATH ä¸­çš„ adb
  â”‚   â”‚
  â”‚   â””â”€â”€ list_devices()  â† `adb devices` è·å–è®¾å¤‡åˆ—è¡¨
  â”‚       â””â”€â”€ è¿‡æ»¤ status == "device" çš„è¡Œ
  â”‚
  â”œâ”€â”€ DeviceManager.connect(device_id)
  â”‚   â”‚
  â”‚   â”œâ”€â”€ device_id == None ?
  â”‚   â”‚   â””â”€â”€ Yes â†’ list_devices()[0]['id']  è‡ªåŠ¨é€‰ç¬¬ä¸€å°
  â”‚   â”‚
  â”‚   â”œâ”€â”€ u2.connect(device_id)  â† uiautomator2 è¿æ¥
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ å»ºç«‹ HTTP è¿æ¥åˆ°è®¾å¤‡ä¸Šçš„ ATX Agent
  â”‚   â”‚   â”‚   â””â”€â”€ é»˜è®¤ç«¯å£: è®¾å¤‡ä¸Šçš„ 7912
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ è·å– u2.info éªŒè¯è¿æ¥
  â”‚   â”‚   â”‚   â”œâ”€â”€ productName (å‹å·)
  â”‚   â”‚   â”‚   â””â”€â”€ version (Android ç‰ˆæœ¬)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ _check_accessibility_service()
  â”‚   â”‚       â””â”€â”€ u2.dump_hierarchy() éªŒè¯æ— éšœç¢æœåŠ¡
  â”‚   â”‚           â”œâ”€â”€ æˆåŠŸ (len > 100) â†’ "âœ… æ— éšœç¢æœåŠ¡: å·²å¯ç”¨"
  â”‚   â”‚           â””â”€â”€ å¤±è´¥ â†’ "âš ï¸  è¯·æ£€æŸ¥ ATX æ— éšœç¢æœåŠ¡"
  â”‚   â”‚
  â”‚   â””â”€â”€ è¿”å› u2 (uiautomator2.Device å®ä¾‹)
  â”‚
  â”œâ”€â”€ self.u2 = u2  â† ä¿å­˜è®¾å¤‡è¿æ¥å¥æŸ„
  â”‚
  â””â”€â”€ _lock_screen_orientation()  â† é”å®šç«–å±
      â”œâ”€â”€ adb shell settings put system accelerometer_rotation 0
      â””â”€â”€ adb shell settings put system user_rotation 0


å®Œæ•´çš„ Android è¿æ¥æ ˆ:

  ç”¨æˆ·ç”µè„‘                           Android æ‰‹æœº
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Python   â”‚                      â”‚                  â”‚
  â”‚          â”‚     USB / WiFi       â”‚  ATX Agent       â”‚
  â”‚  u2 â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€HTTP:7912â”€â”€â”€â”€â”€â”€â–ºâ”‚  (UIAutomator2   â”‚
  â”‚          â”‚                      â”‚   HTTP Server)   â”‚
  â”‚  adb â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€ADB Protocolâ”€â”€â”€â–ºâ”‚                  â”‚
  â”‚          â”‚                      â”‚  Accessibility   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  Service         â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## iOS è®¾å¤‡è¿æ¥é“¾è·¯

```
MobileMCPServer.initialize()
  â”‚
  â–¼
MobileClient(platform="ios")
  â”‚
  â”œâ”€â”€ IOSClientWDA(device_id)
  â”‚   â”‚
  â”‚   â”œâ”€â”€ IOSDeviceManagerWDA()
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ _check_dependencies()
  â”‚   â”‚   â”‚   â”œâ”€â”€ import tidevice   â† USB è®¾å¤‡ç®¡ç†
  â”‚   â”‚   â”‚   â””â”€â”€ import wda        â† WebDriverAgent å®¢æˆ·ç«¯
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ list_devices()
  â”‚   â”‚       â”œâ”€â”€ æ–¹å¼1: tidevice.Usbmux().device_list()  Python API
  â”‚   â”‚       â”œâ”€â”€ æ–¹å¼2: tidevice list --json              CLI å›é€€
  â”‚   â”‚       â””â”€â”€ æ–¹å¼3: xcrun simctl list devices booted  æ¨¡æ‹Ÿå™¨
  â”‚   â”‚
  â”‚   â”œâ”€â”€ IOSDeviceManagerWDA.connect(device_id)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ device_id == None ?
  â”‚   â”‚   â”‚   â””â”€â”€ Yes â†’ list_devices()[0]['id']
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ start_wda_proxy(device_id, port=8100)
  â”‚   â”‚   â”‚   â”‚
  â”‚   â”‚   â”‚   â”œâ”€â”€ æ£€æŸ¥ç«¯å£ 8100 æ˜¯å¦å·²å ç”¨
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ å·²å ç”¨ â†’ "âœ… WDAä»£ç†å·²åœ¨è¿è¡Œ"
  â”‚   â”‚   â”‚   â”‚
  â”‚   â”‚   â”‚   â”œâ”€â”€ å¯åŠ¨ WDA ä»£ç†è¿›ç¨‹ (åå°)
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tidevice -u {udid} wdaproxy \
  â”‚   â”‚   â”‚   â”‚       -B com.facebook.WebDriverAgentRunner.xctrunner \
  â”‚   â”‚   â”‚   â”‚       --port 8100
  â”‚   â”‚   â”‚   â”‚
  â”‚   â”‚   â”‚   â””â”€â”€ è½®è¯¢ç­‰å¾… WDA å¯åŠ¨ (æœ€å¤š 10 ç§’)
  â”‚   â”‚   â”‚       â””â”€â”€ socket.connect_ex(('localhost', 8100))
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ wda.Client('http://localhost:8100')
  â”‚   â”‚   â”‚   â””â”€â”€ client.status() éªŒè¯è¿æ¥
  â”‚   â”‚   â”‚       â”œâ”€â”€ os.version (iOS ç‰ˆæœ¬)
  â”‚   â”‚   â”‚       â””â”€â”€ build.productBundleIdentifier
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ è¿”å› wda.Client å®ä¾‹
  â”‚   â”‚
  â”‚   â””â”€â”€ self.wda = wda_client
  â”‚
  â””â”€â”€ self._ios_client = IOSClientWDA å®ä¾‹


å®Œæ•´çš„ iOS è¿æ¥æ ˆ:

  ç”¨æˆ·ç”µè„‘                           iOS è®¾å¤‡
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Python       â”‚                  â”‚                  â”‚
  â”‚              â”‚                  â”‚  WebDriverAgent  â”‚
  â”‚  wda.Client â”€â”¼â”€â”€HTTP:8100â”€â”€â”   â”‚  (XCTest Runner) â”‚
  â”‚              â”‚             â”‚   â”‚                  â”‚
  â”‚  tidevice â”€â”€â”€â”¼â”€â”€USB/usbmuxâ”€â”¤   â”‚                  â”‚
  â”‚  (wdaproxy)  â”‚             â”‚   â”‚                  â”‚
  â”‚              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                  â”‚
  â”‚              â”‚    â”‚ ç«¯å£è½¬å‘    â”‚                  â”‚
  â”‚              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  :8100            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  è¯´æ˜:
  - tidevice wdaproxy è´Ÿè´£ USB ç«¯å£è½¬å‘ï¼ˆè®¾å¤‡ 8100 â†’ æœ¬æœº 8100ï¼‰
  - wda.Client é€šè¿‡ HTTP åè®®ä¸ WebDriverAgent é€šä¿¡
  - WebDriverAgent éœ€è¦é¦–æ¬¡ç”¨ Xcode ç¼–è¯‘å®‰è£…åˆ°è®¾å¤‡
```

---

## è¿æ¥ä¿æ´»ä¸æ–­çº¿é‡è¿

```
æ¯æ¬¡å·¥å…·è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸ:

  handle_tool_call(name, arguments)
      â”‚
      â–¼
  await self.initialize()          â† æ¯æ¬¡å·¥å…·è°ƒç”¨å‰éƒ½æ£€æŸ¥
      â”‚
      â”œâ”€â”€ _initialized == True ?
      â”‚       â”‚
      â”‚       â–¼
      â”‚   _is_connection_valid()   â† æ ¸å¿ƒä¿æ´»æ£€æŸ¥
      â”‚       â”‚
      â”‚       â”œâ”€â”€â”€ Android: self.client.u2.info
      â”‚       â”‚    â””â”€â”€ å°è¯•è®¿é—®è®¾å¤‡ä¿¡æ¯å±æ€§
      â”‚       â”‚        â”œâ”€â”€ æˆåŠŸ â†’ return True (è¿æ¥æœ‰æ•ˆ)
      â”‚       â”‚        â””â”€â”€ å¼‚å¸¸ â†’ return False (è¿æ¥æ–­å¼€)
      â”‚       â”‚
      â”‚       â”œâ”€â”€â”€ iOS (wda): self.client.wda.status()
      â”‚       â”‚    â””â”€â”€ HTTP GET /status
      â”‚       â”‚        â”œâ”€â”€ æˆåŠŸ â†’ return True
      â”‚       â”‚        â””â”€â”€ å¼‚å¸¸ â†’ return False
      â”‚       â”‚
      â”‚       â””â”€â”€â”€ iOS (_ios_client):
      â”‚            self.client._ios_client.wda.status()
      â”‚                â”œâ”€â”€ æˆåŠŸ â†’ return True
      â”‚                â””â”€â”€ å¼‚å¸¸ â†’ return False
      â”‚
      â”œâ”€â”€ è¿æ¥æœ‰æ•ˆ â†’ ç›´æ¥æ‰§è¡Œå·¥å…·
      â”‚
      â””â”€â”€ è¿æ¥æ— æ•ˆ / æœªåˆå§‹åŒ–
              â”‚
              â–¼
          "âš ï¸ æ£€æµ‹åˆ°è®¾å¤‡è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡æ–°è¿æ¥..."
              â”‚
              â”œâ”€â”€ _initialized = False
              â”œâ”€â”€ self.client = None
              â”œâ”€â”€ self.tools = None
              â”‚
              â–¼
          é‡æ–°æ‰§è¡Œå®Œæ•´åˆå§‹åŒ–æµç¨‹
              â”‚
              â”œâ”€â”€ æˆåŠŸ â†’ ç»§ç»­æ‰§è¡Œå·¥å…·è°ƒç”¨
              â””â”€â”€ å¤±è´¥ â†’ è¿”å›é”™è¯¯æç¤º
                  "è®¾å¤‡è¿æ¥å¤±è´¥: {error}ï¼Œä¸‹æ¬¡è°ƒç”¨æ—¶å°†é‡è¯•"
```

### ä¿æ´»çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         å¯åŠ¨       â”‚          â”‚
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  æœªåˆå§‹åŒ– â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          â”‚                     â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â”‚
                         â”‚                           â”‚
                  é¦–æ¬¡å·¥å…·è°ƒç”¨                    è¿æ¥å¤±è´¥
                         â”‚                     æˆ–è¿æ¥æ–­å¼€
                         â–¼                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
                    â”‚          â”‚     _is_connection   â”‚
                    â”‚  å·²è¿æ¥   â”‚â”€â”€â”€â”€â”€â”€_valid()â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚          â”‚     è¿”å› False      â”‚â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â”‚â”‚
                         â”‚                           â”‚â”‚
                    æ¯æ¬¡å·¥å…·è°ƒç”¨                      â”‚â”‚
                    _is_connection_valid()            â”‚â”‚
                    è¿”å› True                        â”‚â”‚
                         â”‚                           â”‚â”‚
                         â–¼                           â–¼â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          â”‚              â”‚          â”‚
                    â”‚  å·¥å…·æ‰§è¡Œ â”‚              â”‚  é‡è¿ä¸­   â”‚
                    â”‚          â”‚              â”‚          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
                                                â”‚   â”‚
                                           æˆåŠŸ  â”‚   â”‚ å¤±è´¥
                                                â”‚   â”‚
                                       å›åˆ°"å·²è¿æ¥" â”‚
                                                    â”‚
                                              å›åˆ°"æœªåˆå§‹åŒ–"
                                              _last_error è®°å½•é”™è¯¯
```

---

## è®¾å¤‡æ–­å¼€åœºæ™¯ä¸å¤„ç†

| åœºæ™¯ | æ£€æµ‹æ–¹å¼ | å¤„ç†ç­–ç•¥ |
|------|---------|---------|
| **USB çº¿æ–­å¼€** | `u2.info` æŠ›å‡º `ConnectionError` | ä¸‹æ¬¡å·¥å…·è°ƒç”¨æ—¶è‡ªåŠ¨é‡è¿ |
| **WiFi ç½‘ç»œæ–­å¼€** | `u2.info` è¶…æ—¶ | ä¸‹æ¬¡å·¥å…·è°ƒç”¨æ—¶è‡ªåŠ¨é‡è¿ |
| **ATX Agent å´©æºƒ** | `u2.dump_hierarchy()` å¤±è´¥ | é‡è¿æ—¶ u2 ä¼šè‡ªåŠ¨é‡å¯ Agent |
| **iOS WDA å´©æºƒ** | `wda.status()` è¿”å›å¼‚å¸¸ | é‡æ–°å¯åŠ¨ wdaproxy + é‡è¿ |
| **iOS USB æ–­å¼€** | `wda.status()` è¿æ¥æ‹’ç» | é‡æ–°æ‰§è¡Œ tidevice è¿æ¥æµç¨‹ |
| **è®¾å¤‡é‡å¯** | æ‰€æœ‰è¿æ¥æ£€æŸ¥å¤±è´¥ | ç­‰å¾…è®¾å¤‡é‡æ–°ä¸Šçº¿åè‡ªåŠ¨é‡è¿ |
| **MCP Server é‡å¯** | å…¨éƒ¨çŠ¶æ€ä¸¢å¤± | é¦–æ¬¡å·¥å…·è°ƒç”¨é‡æ–°æ‰§è¡Œå®Œæ•´åˆå§‹åŒ– |

---

## å…³é”®ç±»å…³ç³»å›¾

```
MobileMCPServer (mcp_tools/mcp_server.py)
â”‚
â”œâ”€â”€ client: MobileClient (core/mobile_client.py)
â”‚   â”‚
â”‚   â”œâ”€â”€ [Android] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚   â”œâ”€â”€ device_manager: DeviceManager (core/device_manager.py)
â”‚   â”‚   â”‚   â”œâ”€â”€ adb_path: str               â† ADB å¯æ‰§è¡Œè·¯å¾„
â”‚   â”‚   â”‚   â”œâ”€â”€ current_device_id: str       â† å½“å‰è®¾å¤‡ serial
â”‚   â”‚   â”‚   â”œâ”€â”€ u2: uiautomator2.Device     â† è®¾å¤‡è¿æ¥å¥æŸ„
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ list_devices() â†’ [{id, status}]
â”‚   â”‚   â”‚   â”œâ”€â”€ connect(device_id) â†’ u2.Device
â”‚   â”‚   â”‚   â”œâ”€â”€ check_device_status() â†’ {connected, device_id, ...}
â”‚   â”‚   â”‚   â”œâ”€â”€ check_accessibility_service() â†’ {enabled, ...}
â”‚   â”‚   â”‚   â””â”€â”€ disconnect()
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ u2: uiautomator2.Device         â† åŒ device_manager.u2
â”‚   â”‚   â”œâ”€â”€ smart_wait: SmartWait           â† æ™ºèƒ½ç­‰å¾…å·¥å…·
â”‚   â”‚   â”œâ”€â”€ xml_parser: XMLParser           â† UI æ ‘è§£æ
â”‚   â”‚   â””â”€â”€ xml_formatter: XMLFormatter     â† AI å‹å¥½æ ¼å¼åŒ–
â”‚   â”‚
â”‚   â””â”€â”€ [iOS] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚       â”œâ”€â”€ _ios_client: IOSClientWDA (core/ios_client_wda.py)
â”‚       â”‚   â”œâ”€â”€ device_manager: IOSDeviceManagerWDA (core/ios_device_manager_wda.py)
â”‚       â”‚   â”‚   â”œâ”€â”€ client: wda.Client           â† WDA è¿æ¥å¥æŸ„
â”‚       â”‚   â”‚   â”œâ”€â”€ current_device_id: str       â† UDID
â”‚       â”‚   â”‚   â”œâ”€â”€ _wda_proxy_process: Popen    â† tidevice wdaproxy è¿›ç¨‹
â”‚       â”‚   â”‚   â”‚
â”‚       â”‚   â”‚   â”œâ”€â”€ list_devices() â†’ [{id, name, type, state}]
â”‚       â”‚   â”‚   â”œâ”€â”€ start_wda_proxy(device_id, port) â†’ bool
â”‚       â”‚   â”‚   â”œâ”€â”€ connect(device_id) â†’ wda.Client
â”‚       â”‚   â”‚   â”œâ”€â”€ check_device_status() â†’ {connected, ...}
â”‚       â”‚   â”‚   â””â”€â”€ disconnect()  â† ç»ˆæ­¢ wdaproxy è¿›ç¨‹
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ wda: wda.Client              â† åŒ device_manager.client
â”‚       â”‚
â”‚       â””â”€â”€ wda: wda.Client                  â† åŒ _ios_client.wda
â”‚
â””â”€â”€ tools: BasicMobileToolsLite (core/basic_tools_lite.py)
    â”‚
    â”œâ”€â”€ 27 ä¸ª MCP å·¥å…·ï¼ˆæˆªå›¾ã€ç‚¹å‡»ã€è¾“å…¥ã€æ»‘åŠ¨ã€æŒ‰é”®ç­‰ï¼‰
    â”œâ”€â”€ _mobile_client: MobileClient å¼•ç”¨
    â””â”€â”€ å†…éƒ¨é€šè¿‡ client.u2 / client.wda æ‰§è¡Œè®¾å¤‡æ“ä½œ
```

---

## ç«¯å£ä¸åè®®æ±‡æ€»

| è¿æ¥ | åè®® | ç«¯å£ | è¯´æ˜ |
|------|------|------|------|
| **ADB â†’ Android** | ADB Protocol | USB / TCP:5555 | è®¾å¤‡ç®¡ç†ã€shell å‘½ä»¤ |
| **u2 â†’ ATX Agent** | HTTP | è®¾å¤‡:7912 | UI æ“ä½œã€æˆªå›¾ã€é¡µé¢ç»“æ„ |
| **tidevice â†’ iOS** | USB (usbmux) | - | è®¾å¤‡å‘ç°ã€ç«¯å£è½¬å‘ |
| **wdaproxy â†’ WDA** | HTTP ç«¯å£è½¬å‘ | æœ¬æœº:8100 â†’ è®¾å¤‡:8100 | UI æ“ä½œã€æˆªå›¾ |
| **wda.Client â†’ WDA** | HTTP | localhost:8100 | æœ€ç»ˆé€šä¿¡ç«¯ç‚¹ |

---

## ä» MCP Server åˆ°æ‰‹æœºçš„å®Œæ•´è°ƒç”¨é“¾

```
Backend (FastAPI)
  â”‚ SSE POST /messages
  â–¼
MCP Server (HTTP :3100)
  â”‚ handle_tool_call("mobile_click_by_text", {text: "ç™»å½•"})
  â–¼
MobileMCPServer
  â”‚ await self.initialize()        â† ä¿æ´»æ£€æŸ¥
  â”‚ result = self.tools.click_by_text("ç™»å½•")
  â–¼
BasicMobileToolsLite
  â”‚ self._mobile_client.u2(text="ç™»å½•").click()
  â–¼
MobileClient.u2 (uiautomator2.Device)
  â”‚ HTTP POST â†’ ATX Agent
  â–¼
Android æ‰‹æœº
  â”‚ UIAutomator2 æ‰§è¡Œç‚¹å‡»
  â–¼
ğŸ“± å±å¹•ä¸Š"ç™»å½•"æŒ‰é’®è¢«ç‚¹å‡»
```

```
åŒæ ·çš„è°ƒç”¨é“¾ï¼ˆiOS ç‰ˆæœ¬ï¼‰:

Backend â†’ MCP Server â†’ MobileMCPServer
  â”‚ await self.initialize()
  â”‚ result = self.tools.click_by_text("ç™»å½•")
  â–¼
BasicMobileToolsLite
  â”‚ self._mobile_client._ios_client.wda(text="ç™»å½•").click()
  â–¼
IOSClientWDA.wda (wda.Client)
  â”‚ HTTP POST â†’ localhost:8100
  â–¼
tidevice wdaproxy (ç«¯å£è½¬å‘)
  â”‚ USB â†’ è®¾å¤‡ :8100
  â–¼
WebDriverAgent (XCTest Runner)
  â”‚ XCUITest API æ‰§è¡Œç‚¹å‡»
  â–¼
ğŸ“± å±å¹•ä¸Š"ç™»å½•"æŒ‰é’®è¢«ç‚¹å‡»
```
